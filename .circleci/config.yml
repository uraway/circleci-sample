version: 2.1

jobs:
  backup_job:
    docker:
      - image: circleci/python:3.7-stretch
    steps:
      - add_ssh_keys: # ・・・ 1
          fingerprints:
            - "51:73:ba:b2:f2:3b:8a:21:fc:5b:14:80:71:ac:bf:f3"
      - run: # ・・・ 2
          name: "DBバックアップを作成する"
          command:
            mkdir -p backups
            today=$(date "+%Y%m%d")
            echo "pg_dump -Fc postgres" >> "${today}.dump" | ssh -oStrictHostKeyChecking=no -l ${USER} ${HOST}
      #- run: # ・・・ 3
      #    name: "DBバックアップを取得する"
      #    command:
      #      scp -r ${USER}@${HOST}:/home/someuser/someapp/backups ./
      - run:  # ・・・ 4
          name: Install awscli
          command: sudo pip install awscli
      - run:
          name: Deploy to S3
          command: aws s3 sync ./backups s3://s3://circleci-sample-app-backup/backups
      - store_artifacts:
          name: "DBバックアップをCircleCIにアップロードする"
          path: ./backups
workflows:
  version: 2
  backup:
    #triggers:
    #  - schedule:
    #      cron: "0 0 * * *"
    #      filters:
    #        branches:
    #          only:
    #            - master
    jobs:
      - backup_job
