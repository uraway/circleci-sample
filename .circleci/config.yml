version: 2.1

orbs:
  cli: circleci/circleci-cli@0.1.5
  orb-tools: circleci/orb-tools@8.27.4

jobs:
    test:
      executor: orb-tools/alpine
      steps:
        - setup_remote_docker
        - run:
            name: Dockerクライアントのインストール
            command:
              set -ex \
                && export DOCKER_VERSION=$(curl --silent --fail --retry 3 https://download.docker.com/linux/static/stable/x86_64/ | grep -o -e 'docker-[.0-9]*-ce\.tgz' | sort -r | head -n 1) \
                && DOCKER_URL="https://download.docker.com/linux/static/stable/x86_64/${DOCKER_VERSION}" \
                && echo Docker URL: $DOCKER_URL \
                && curl --silent --show-error --location --fail --retry 3 --output /tmp/docker.tgz "${DOCKER_URL}" \
                && ls -lha /tmp/docker.tgz \
                && tar -xz -C /tmp -f /tmp/docker.tgz \
                && mv /tmp/docker/* /usr/bin \
                && rm -rf /tmp/docker /tmp/docker.tgz \
                && which docker \
                && (docker version || true)
        - run: docker -v
        - cli/install
        - checkout
        - run: pwd
        #- run: circleci config process .circleci/test.yml > config.yml
        - orb-tools/local-test-build:
            test-config-location: .circleci/test.yml
        #- run: circleci local execute --config config.yml --job hello-world/echo_job | tee local_build_output.txt /dev/stderr | tail -n 1 | grep "Success"

workflows:
  main:
    jobs:
      - test
