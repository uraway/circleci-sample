version: 2
jobs:
  build:
    machine: true
    steps:
    - checkout
    - restore_cache:
        keys:
        - v3-image-{{ .Branch }}
        - v3-image-
    - run:
        command: |
          set +o pipefail
          docker load -i ~/caches/${CIRCLE_PROJECT_REPONAME}.tar | true
    - run:
        command: |
          docker images
    - run:
        command: |
          docker build --cache-from=${CIRCLE_PROJECT_REPONAME}:latest -t ${CIRCLE_PROJECT_REPONAME} .
    - run:
        command: |
          docker run ${CIRCLE_PROJECT_REPONAME} phantomjs screenshot.js
    - store_artifacts:
        path: ./screenshot.png
    - run:
        command: |
          mkdir -p ~/caches
          docker save -o ~/caches/${CIRCLE_PROJECT_REPONAME}.tar ${CIRCLE_PROJECT_REPONAME}
    - save_cache:
        key: v3-image-{{ .Branch }}-{{ epoch }}
        paths:
        - ~/caches
workflows:
  version: 2
  main:
    jobs:
    - build
